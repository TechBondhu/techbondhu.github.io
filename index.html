<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chat Bot</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: "Segoe UI", sans-serif;
  background-color: #E5E7EB;
  color: #333;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
  margin: 0;
  overflow: hidden;
}

.chat-container {
  width: 100vw;
  height: 100vh;
  background-color: #ffffff;
  color: #000000;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.2);
  transition: margin-left 0.3s ease, width 0.3s ease;
  position: relative;
  z-index: 1;
}

.chat-container.sidebar-open {
  margin-left: 300px;
  width: calc(100vw - 300px);
}

.header {
  background-color: #1E3A8A;
  color: #fff;
  padding: 15px;
  font-size: 24px;
  font-weight: bold;
  text-align: center;
  border-bottom: 2px solid #ddd;
  position: relative;
  display: flex;
  justify-content: center;
  align-items: center;
}

.header-icons {
  position: absolute;
  left: 20px;
  top: 50%;
  transform: translateY(-50%);
  display: flex;
  gap: 15px;
}

.history-icon,
.new-chat-icon {
  font-size: 24px;
  color: #fff;
  cursor: pointer;
  transition: color 0.3s ease;
}

.history-icon:hover,
.new-chat-icon:hover {
  color: #3B82F6;
}

.sidebar {
  position: fixed;
  top: 0;
  left: -300px;
  width: 300px;
  height: 100%;
  background-color: #1E3A8A;
  color: #fff;
  padding: 20px;
  transition: left 0.3s ease;
  z-index: 10;
  display: flex;
  flex-direction: column;
  gap: 15px;
  box-shadow: 2px 0 5px rgba(0, 0, 0, 0.3);
}

.sidebar.open {
  left: 0;
}

.sidebar h3 {
  font-size: 22px;
  margin-bottom: 10px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  padding-bottom: 10px;
}

.history-list {
  flex-grow: 1;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.history-item {
  background-color: rgba(255, 255, 255, 0.1);
  padding: 15px;
  border-radius: 10px;
  cursor: pointer;
  transition: background-color 0.3s ease, transform 0.2s ease;
}

.history-item:hover {
  background-color: rgba(255, 255, 255, 0.2);
  transform: translateX(5px);
}

.history-item p {
  font-size: 16px;
  color: #fff;
  margin: 0;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.history-item .timestamp {
  font-size: 12px;
  color: rgba(255, 255, 255, 0.6);
  margin-top: 5px;
}

.chat-box {
  flex-grow: 1;
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 20px;
  overflow-y: auto;
  height: 100%;
  background: linear-gradient(135deg, #f9f9f9, #E5E7EB);
  position: relative;
}

.welcome-message {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
  z-index: 2;
  width: 100%;
  padding: 20px;
}

.welcome-message h2 {
  font-size: 28px;
  color: #333;
  margin-bottom: 20px;
}

.welcome-buttons {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 10px;
}

.welcome-buttons button {
  padding: 10px 20px;
  border: 1px solid #ccc;
  border-radius: 20px;
  background: #fff;
  color: #333;
  font-size: 14px;
  cursor: pointer;
  transition: background-color 0.3s ease, transform 0.2s ease;
}

.welcome-buttons button:hover {
  background-color: #f0f0f0;
  transform: scale(1.05);
}

.welcome-buttons button i {
  margin-right: 5px;
}

.welcome-buttons button:nth-child(1) {
  color: #FF6F61;
}
.welcome-buttons button:nth-child(2) {
  color: #6B7280;
}
.welcome-buttons button:nth-child(3) {
  color: #F59E0B;
}

.messages {
  flex-grow: 1;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  z-index: 2;
}

.user-message,
.bot-message {
  padding: 15px 20px;
  border-radius: 12px;
  max-width: 60%;
  word-wrap: break-word;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
  font-size: 18px;
  margin-bottom: 10px;
}

.user-message {
  background-color: #3B82F6;
  color: #fff;
  text-align: right;
  margin-left: auto;
}

.bot-message {
  background-color: #E5E7EB;
  color: #333;
  text-align: left;
}

.input-area {
  display: flex;
  align-items: center;
  gap: 15px;
  padding: 15px;
  background: #fff;
  border-top: 1px solid #ccc;
  position: relative;
  z-index: 2;
}

#userInput {
  flex-grow: 1;
  padding: 12px;
  font-size: 18px;
  border: 1px solid #ccc;
  border-radius: 20px;
  outline: none;
  transition: border-color 0.3s ease;
}

#userInput:focus {
  border-color: #3B82F6;
}

#sendBtn,
#uploadBtn {
  width: 55px;
  height: 55px;
  border-radius: 50%;
  background-color: #1E3A8A;
  color: #fff;
  border: none;
  cursor: pointer;
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 22px;
  transition: background-color 0.3s ease, transform 0.2s ease;
}

#sendBtn:hover,
#uploadBtn:hover {
  background-color: #3B82F6;
  transform: scale(1.1);
}

#uploadBtn {
  font-size: 24px;
}

/* রেসপনসিভ ডিজাইন */
@media (max-width: 768px) {
  .sidebar {
    width: 250px;
  }
  .chat-container.sidebar-open {
    margin-left: 250px;
    width: calc(100vw - 250px);
  }
}

@media (max-width: 480px) {
  .sidebar {
    width: 200px;
  }
  .chat-container.sidebar-open {
    margin-left: 200px;
    width: calc(100vw - 200px);
  }
  .user-message,
  .bot-message {
    max-width: 80%;
  }
}
@media (max-width: 480px) CTL
  .welcome-message h2 {
    font-size: 20px;
  }
  .welcome-buttons button {
    font-size: 12px;
    padding: 8px 16px;
  }
}
      
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="header">
      <div class="header-icons">
        <i class="fas fa-bars history-icon" onclick="toggleSidebar()"></i>
        <i class="fas fa-pen-to-square new-chat-icon" onclick="startNewChat()"></i>
      </div>
      Formbondhu
    </div>
    <div class="sidebar" id="sidebar">
      <h3>History</h3>
      <div class="history-list" id="historyList"></div>
    </div>
    <div class="chat-box">
      <div class="welcome-message" id="welcomeMessage">
        <h2>How can Formbondhu assist you today?</h2>
        <div class="welcome-buttons">
          <button onclick="sendMessage('Submit an application')"><i class="fas fa-paper-plane"></i>Submit an application</button>
          <button onclick="sendMessage('Get support')"><i class="fas fa-headset"></i>Get support</button>
          <button onclick="sendMessage('Ask a question')"><i class="fas fa-question-circle"></i>Ask a question</button>
        </div>
      </div>
      <div class="messages" id="messages"></div>
    </div>
    <div class="input-area">
      <input type="text" id="userInput" placeholder="Type your message...">
      <button id="uploadBtn">+</button>
      <input type="file" id="fileInput" style="display: none;" accept="image/png, image/jpeg">
      <button id="sendBtn"><i class="fas fa-arrow-up"></i></button>
    </div>
  </div>

  <script>
document.addEventListener('DOMContentLoaded', () => {
  const sendBtn = document.getElementById('sendBtn');
  const userInput = document.getElementById('userInput');
  const messagesDiv = document.getElementById('messages');
  const uploadBtn = document.getElementById('uploadBtn');
  const fileInput = document.getElementById('fileInput');
  const welcomeMessage = document.getElementById('welcomeMessage');
  const sidebar = document.getElementById('sidebar');
  const historyList = document.getElementById('historyList');
  const chatContainer = document.querySelector('.chat-container');

  const rasaEndpoint = "http://localhost:5005/webhooks/rest/webhook";
  const flaskEndpoint = "http://localhost:5000/upload";

  let firstMessageSent = false;
  let chatHistory = [];
  let currentChatIndex = -1;

  // লোকাল স্টোরেজ থেকে হিস্ট্রি লোড করা
  function loadFromLocalStorage() {
    const storedHistory = localStorage.getItem('chatHistory');
    if (storedHistory) {
      chatHistory = JSON.parse(storedHistory);
      currentChatIndex = chatHistory.length > 0 ? 0 : -1; // প্রথম চ্যাট লোড করা
      updateHistory();
      if (currentChatIndex >= 0) {
        loadChat(currentChatIndex);
      }
    }
  }

  // লোকাল স্টোরেজে হিস্ট্রি সেভ করা
  function saveToLocalStorage() {
    localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
  }

  sendBtn.addEventListener('click', sendMessage);
  userInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      sendMessage();
    }
  });

  uploadBtn.addEventListener('click', () => {
    fileInput.click();
  });

  fileInput.addEventListener('change', () => {
    const file = fileInput.files[0];
    if (file && file.type.startsWith('image/')) {
      uploadImageToFlask(file);
    }
  });

  function sendMessage(predefinedMessage = null) {
    const userMessage = predefinedMessage || userInput.value.trim();
    if (userMessage === '') return;

    if (!firstMessageSent) {
      welcomeMessage.style.display = 'none';
      firstMessageSent = true;
      startNewChatSession(userMessage);
    } else {
      if (currentChatIndex === -1) {
        startNewChatSession(userMessage);
      } else {
        chatHistory[currentChatIndex].messages.push({ sender: 'user', text: userMessage });
      }
    }

    displayMessage(userMessage, 'user');
    userInput.value = '';
    updateHistory();

    fetch(rasaEndpoint, {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        sender: "user",
        message: userMessage
      })
    })
    .then(response => response.json())
    .then(data => {
      if (Array.isArray(data)) {
        data.forEach(entry => {
          if (entry.text) {
            chatHistory[currentChatIndex].messages.push({ sender: 'bot', text: entry.text });
            displayMessage(entry.text, 'bot');
          } else if (entry.image) {
            chatHistory[currentChatIndex].messages.push({ sender: 'bot', image: entry.image });
            displayImage(entry.image);
          }
        });
        updateHistory();
      }
    })
    .catch(error => {
      console.error("Error communicating with Rasa:", error);
      displayMessage("❌ সার্ভারের সাথে যোগাযোগ করা যাচ্ছে না!", 'bot');
      chatHistory[currentChatIndex].messages.push({ sender: 'bot', text: "❌ সার্ভারের সাথে যোগাযোগ করা যাচ্ছে না!" });
      updateHistory();
    });
  }

  function uploadImageToFlask(file) {
    if (!firstMessageSent) {
      welcomeMessage.style.display = 'none';
      firstMessageSent = true;
      startNewChatSession("Image upload");
    } else {
      if (currentChatIndex === -1) {
        startNewChatSession("Image upload");
      }
    }

    const formData = new FormData();
    formData.append('file', file);

    fetch(flaskEndpoint, {
      method: "POST",
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.url) {
        const imageUrl = data.url;
        chatHistory[currentChatIndex].messages.push({ sender: 'bot', text: `✅ ইমেজ আপলোড সফল! URL: ${imageUrl}` });
        displayMessage(`✅ ইমেজ আপলোড সফল! URL: ${imageUrl}`, 'bot');
        updateHistory();

        fetch(rasaEndpoint, {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            sender: "user",
            message: imageUrl
          })
        })
        .then(response => response.json())
        .then(data => {
          data.forEach(entry => {
            if (entry.text) {
              chatHistory[currentChatIndex].messages.push({ sender: 'bot', text: entry.text });
              displayMessage(entry.text, 'bot');
            }
          });
          updateHistory();
        })
        .catch(error => {
          console.error("Error sending URL to Rasa:", error);
          chatHistory[currentChatIndex].messages.push({ sender: 'bot', text: "❌ Rasa-এ URL পাঠাতে সমস্যা!" });
          displayMessage("❌ Rasa-এ URL পাঠাতে সমস্যা!", 'bot');
          updateHistory();
        });
      } else {
        chatHistory[currentChatIndex].messages.push({ sender: 'bot', text: `❌ ইমেজ আপলোডে সমস্যা: ${data.error}` });
        displayMessage(`❌ ইমেজ আপলোডে সমস্যা: ${data.error}`, 'bot');
        updateHistory();
      }
    })
    .catch(error => {
      console.error("Error uploading image to Flask:", error);
      chatHistory[currentChatIndex].messages.push({ sender: 'bot', text: "❌ Flask API-এ ইমেজ আপলোডে সমস্যা!" });
      displayMessage("❌ Flask API-এ ইমেজ আপলোডে সমস্যা!", 'bot');
      updateHistory();
    });
  }

  function displayMessage(message, sender) {
    const messageDiv = document.createElement('div');
    messageDiv.classList.add(sender === 'user' ? 'user-message' : 'bot-message');
    messageDiv.innerText = message;
    messagesDiv.appendChild(messageDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  function displayImage(imageUrl) {
    const img = document.createElement('img');
    img.src = imageUrl;
    img.style.maxWidth = '200px';
    img.style.margin = '10px 0';
    messagesDiv.appendChild(img);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  function startNewChatSession(firstMessage) {
    const timestamp = new Date().toLocaleString();
    chatHistory.push({
      messages: [{ sender: 'user', text: firstMessage }],
      timestamp: timestamp
    });
    currentChatIndex = chatHistory.length - 1;
    saveToLocalStorage(); // নতুন চ্যাট সেশন সেভ করা
  }

  function startNewChat() {
    messagesDiv.innerHTML = '';
    welcomeMessage.style.display = 'block';
    firstMessageSent = false;
    currentChatIndex = -1;
    updateHistory();
  }

  function toggleSidebar() {
    sidebar.classList.toggle('open');
    chatContainer.classList.toggle('sidebar-open');
  }

  function updateHistory() {
    historyList.innerHTML = '';
    chatHistory.forEach((chat, index) => {
      const historyItem = document.createElement('div');
      historyItem.classList.add('history-item');
      historyItem.innerHTML = `
        <p>${chat.messages[0].text.substring(0, 50)}${chat.messages[0].text.length > 50 ? '...' : ''}</p>
        <div class="timestamp">${chat.timestamp}</div>
      `;
      historyItem.addEventListener('click', () => loadChat(index));
      historyList.appendChild(historyItem);
    });
    saveToLocalStorage(); // হিস্ট্রি আপডেটের পর সেভ করা
  }

  function loadChat(index) {
    currentChatIndex = index;
    messagesDiv.innerHTML = '';
    welcomeMessage.style.display = 'none';
    firstMessageSent = true;
    chatHistory[index].messages.forEach(msg => {
      if (msg.text) {
        displayMessage(msg.text, msg.sender);
      } else if (msg.image) {
        displayImage(msg.image);
      }
    });
    sidebar.classList.remove('open');
    chatContainer.classList.remove('sidebar-open');
  }

  // পেজ লোডের সময় হিস্ট্রি লোড করা
  loadFromLocalStorage();
});
  </script>
</body>
</html>
